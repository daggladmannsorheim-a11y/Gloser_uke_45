<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>Snake ‚Äì Gloser uke 45 (Kampen 6. trinn)</title>
<style>
  :root{
    --bg:#0c1020; --panel:#151a2b; --ink:#eef3fb; --muted:#9fb1d1; --line:#223059;
    --good:#42d392; --bad:#ff6b6b; --head:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100vh;margin:0;background:#0c1020;color:var(--ink);font:16px system-ui,Segoe UI,Roboto,Arial}
  @media (min-width:900px){ html,body{overflow:hidden} }

  header{padding:8px 12px;background:rgba(21,26,43,.95);border-bottom:1px solid var(--line);position:sticky;top:0;text-align:center}
  h1{margin:0;font-size:18px}
  .muted{color:var(--muted);font-size:14px}

  .screen{
    height: calc(100vh - var(--head));
    display:grid; grid-template-columns: 1fr 320px; gap:10px; padding:8px;
  }
  @media (max-width:900px){ .screen{grid-template-columns:1fr; height:auto; min-height:calc(100vh - var(--head)); padding:6px} }

  #canvasBox{
    background: radial-gradient(1000px 480px at 30% -8%, #18234a, #0c1020 60%);
    border:1px solid var(--line); border-radius:12px; padding:8px; display:flex; align-items:center; justify-content:center; position:relative;
  }
  #game{
    width:100%; height:100%; aspect-ratio:3/2; background:#0a1020; border:1px solid #1b274b; border-radius:10px; touch-action:none; display:block;
  }

  #startOverlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35); border-radius:10px; z-index:5;
  }
  #startOverlay button{
    font-size:clamp(18px,4.5vw,26px); padding:14px 20px; border-radius:12px; background:#1b3b2e; color:#fff; border:1px solid #225a42; font-weight:800;
  }

  #side{display:flex; flex-direction:column; gap:8px; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px}
  .chips{display:flex; flex-wrap:wrap; gap:6px}
  .chip{display:inline-flex; gap:6px; align-items:center; background:#1a2240; border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:14px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  button{appearance:none; background:#1b274b; color:var(--ink); border:1px solid var(--line); padding:8px 12px; border-radius:10px; font-weight:700; font-size:15px}
  button:active{transform:translateY(1px)} .btn-prim{background:#1b3b2e; border-color:#225a42}
  label.pill{display:inline-flex; align-items:center; gap:6px; background:#1a2240; border:1px solid var(--line); border-radius:999px; padding:5px 10px; font-size:14px}

  #mobileCtrlBar{display:none}
  @media (max-width:900px){
    #mobileCtrlBar{display:flex; gap:8px; justify-content:center; margin-top:6px}
    #mobileCtrlBar button{flex:0 0 auto}
  }

  #mobControls{display:none}
  @media (max-width:600px){
    #mobControls{display:grid; place-items:center; gap:6px}
    #mobControls .row{display:flex; gap:12px; justify-content:center}
    #mobControls button{width:56px; height:56px; font-size:26px; border-radius:12px}
  }

  #modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50; padding:10px}
  #card{width:min(94vw,620px); background:#0f1734; border:1px solid #2a3a68; border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .qTitle{margin:0 0 8px; font-size:clamp(18px,3.8vw,22px); font-weight:800}
  #ans{width:100%; padding:12px 14px; font-size:18px; border-radius:10px; border:1px solid #2a3a68; background:#101833; color:#fff}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .qRow{display:flex; gap:8px; align-items:center; margin-top:10px}
  .qRow .left{display:flex; gap:8px; flex-wrap:wrap}
  .qRow .right{margin-left:auto}
  #qFasit{display:none; margin-top:10px; max-height:40vh; overflow:auto; border:1px solid #2a3a68; border-radius:10px}
  table{width:100%; border-collapse:collapse; font-size:15px}
  th,td{border:1px solid #2a3a68; padding:6px 8px; text-align:left}
  th{background:#1a2240}

  @media (max-width:420px){
    header h1{font-size:16px}
    .chip{font-size:12px; padding:3px 8px}
    button{font-size:14px; padding:7px 10px}
    #ans{font-size:17px}
  }
</style>
</head>
<body>
<header>
  <h1>Snake ‚Äì Gloser ‚Ä¢ Uke 45</h1>
  <div class="muted">Hei 6. trinn p√• Kampen skole! Kos dere med glosespill ‚Äì l√¶r, spill og ha det g√∏y üçéüêç</div>
</header>

<section class="screen">
  <div id="canvasBox">
    <canvas id="game" width="900" height="600" aria-label="Snake-spill"></canvas>
    <div id="startOverlay"><button id="bigStart">Start spillet</button></div>
  </div>

  <aside id="side">
    <div class="chips">
      <span class="chip">Poeng: <b id="score">0</b></span>
      <span class="chip">Liv: <b id="lives">‚ù§‚ù§‚ù§</b></span>
      <span class="chip">Fart: <b id="speedShow">6</b></span>
      <span class="chip">Topp: <b id="best">0</b></span>
      <span class="chip">Oppgaver igjen: <b id="remain">10</b></span>
    </div>

    <div class="row" style="align-items:center">
      <button id="start" class="btn-prim">Start / Restart</button>
      <button id="pause">Pause</button>
      <label style="display:flex;align-items:center;gap:6px">Fart <input id="speed" type="range" min="4" max="16" value="6" /></label>
      <label class="pill"><input type="checkbox" id="assist"> Lett √• treffe (magnet)</label>
    </div>

    <div id="mobileCtrlBar"></div>

    <div id="mobControls">
      <div class="row"><button id="up">‚¨ÜÔ∏è</button></div>
      <div class="row">
        <button id="left">‚¨ÖÔ∏è</button>
        <button id="down">‚¨áÔ∏è</button>
        <button id="right">‚û°Ô∏è</button>
      </div>
    </div>
  </aside>
</section>

<div id="modal">
  <div id="card">
    <div id="questionView">
      <p class="qTitle">Skriv <span class="good">engelsk</span> for: <span id="norw" class="good"></span></p>
      <input id="ans" type="text" inputmode="latin" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="skriv engelsk og trykk Enter/Sjekk" />
      <div class="qRow">
        <div class="left">
          <button id="check" class="btn-prim">Sjekk</button>
          <button id="skip">Hopp over (‚Äì1 liv)</button>
        </div>
        <div class="right">
          <button id="toggleQFasit">Vis fasit ‚ñº</button>
        </div>
      </div>
      <div id="qFasit"></div>
    </div>

    <div id="summaryView" style="display:none">
      <h3 style="margin:0 0 8px">Oppsummering</h3>
      <div id="summaryText" style="margin-bottom:10px"></div>
      <button id="restartAll" class="btn-prim">Spill igjen</button>
    </div>
  </div>
</div>

<script>
/* ====== Gloser uke 45 ====== */
const PAIRS = [
  {en:"Decent", no:"ordentlig"},
  {en:"Grin", no:"smil"},
  {en:"Terrified", no:"veldig redd"},
  {en:"Wailed", no:"gr√•t"},
  {en:"Yelping", no:"bjeffende"},
  {en:"Leer", no:"sultent blikk"},
  {en:"Furry coat", no:"pelsk√•pe"},
  {en:"Flickers", no:"blunker i rykninger"},
  {en:"Whips out", no:"trekker frem"},
  {en:"Knickers", no:"underbukser"}
];

function setHeaderVar(){
  const h = document.querySelector('header').offsetHeight || 56;
  document.documentElement.style.setProperty('--head', h + 'px');
}
window.addEventListener('resize', setHeaderVar); setHeaderVar();

/* ====== DOM ====== */
const cv = document.getElementById('game'), ctx = cv.getContext('2d');
const ui = {
  score: document.getElementById('score'),
  lives: document.getElementById('lives'),
  best: document.getElementById('best'),
  speed: document.getElementById('speed'),
  speedShow: document.getElementById('speedShow'),
  start: document.getElementById('start'),
  pause: document.getElementById('pause'),
  up: document.getElementById('up'), down: document.getElementById('down'),
  left: document.getElementById('left'), right: document.getElementById('right'),
  remain: document.getElementById('remain'),
  bigStart: document.getElementById('bigStart'),
  startOverlay: document.getElementById('startOverlay'),
  assist: document.getElementById('assist')
};
const modal = document.getElementById('modal');
const questionView = document.getElementById('questionView');
const summaryView  = document.getElementById('summaryView');
const summaryText  = document.getElementById('summaryText');
const restartAll   = document.getElementById('restartAll');

const norw  = document.getElementById('norw');
const ans   = document.getElementById('ans');
const btnCheck = document.getElementById('check');
const btnSkip  = document.getElementById('skip');
const btnToggleQFasit = document.getElementById('toggleQFasit');
const qFasitDiv = document.getElementById('qFasit');

const LS_KEY = "snake45_best_mobile_tight_easy";
ui.best.textContent = localStorage.getItem(LS_KEY) || 0;

/* ====== Fasit-tabell ====== */
qFasitDiv.innerHTML = `<table>
  <tr><th>Engelsk</th><th>Norsk</th></tr>
  ${PAIRS.map(p=>`<tr><td>${p.en}</td><td>${p.no}</td></tr>`).join('')}
</table>`;

/* ====== Canvas sizing (3:2) + mindre brett p√• sm√• mobiler ====== */
let gridBase = (window.innerWidth <= 420) ? 30 : 26; // üî∏ st√∏rre ruter => f√¶rre ruter (lettere √• treffe)
let grid = gridBase, cols = Math.floor(cv.width / grid), rows = Math.floor(cv.height / grid);
function fitCanvas(){
  const box = document.getElementById('canvasBox');
  const bw = box.clientWidth - 16, bh = box.clientHeight - 16;
  if (bw <= 0 || bh <= 0) return;
  let targetW = bw, targetH = Math.round(bw * 2/3);
  if (targetH > bh){ targetH = bh; targetW = Math.round(bh * 3/2); }
  cv.style.width = targetW + 'px';
  cv.style.height = targetH + 'px';
  const ratio = window.devicePixelRatio || 1;
  const w = Math.floor(targetW * ratio);
  const h = Math.floor(targetH * ratio);
  if (cv.width !== w || cv.height !== h){
    cv.width = w; cv.height = h;
    cols = Math.floor(w / grid);
    rows = Math.floor(h / grid);
  }
}
window.addEventListener('resize', ()=>{
  gridBase = (window.innerWidth <= 420) ? 30 : 26;
  grid = gridBase;
  fitCanvas();
});

/* ====== Utils ====== */
const rand = n => Math.floor(Math.random()*n);
const norm = s => s.trim().toLowerCase().replace(/\s+/g," ");
function toast(msg, ok=true, t=1200){
  const e=document.createElement('div');
  e.textContent=msg;
  e.style.position="fixed"; e.style.left="50%"; e.style.top="50%";
  e.style.transform="translate(-50%,-50%)";
  e.style.background= ok ? "#1f503a" : "#5b2230";
  e.style.color="#fff"; e.style.padding="14px 18px";
  e.style.borderRadius="12px"; e.style.fontSize="22px"; e.style.fontWeight="800";
  e.style.boxShadow="0 0 20px rgba(0,0,0,.5)"; e.style.zIndex=200;
  document.body.appendChild(e);
  setTimeout(()=>e.remove(), t);
}

/* ====== Spilltilstand ====== */
let snake, dir, nextDir, score, lives, paused=true, loopId=null, lastTick=0,
    speedMs = 1000/6, growth=0; // üî∏ litt saktere standardfart

/* Apples: ett per glose */
let apples = []; // {x,y,index,done:false}

/* Statistikk */
let currentIndex = null;
let usedFasitThisRound = false;
let correctCount = 0, wrongCount = 0, withFasitAttempts = 0, withoutFasitAttempts = 0;

/* ====== Plassering og reset ====== */
function freeCell(){
  let x,y,tries=0;
  do{
    x=rand(cols); y=rand(rows); tries++; if(tries>2000) break;
  }while(
    snake.some(s=>s.x===x&&s.y===y) ||
    apples.some(a=>!a.done && a.x===x && a.y===y)
  );
  return {x,y};
}
function placeAllApples(){
  apples = [];
  for(let i=0;i<PAIRS.length;i++){
    const {x,y} = freeCell();
    apples.push({x,y,index:i,done:false});
  }
  ui.remain.textContent = apples.filter(a=>!a.done).length;
}
function resetStats(){
  correctCount=0; wrongCount=0; withFasitAttempts=0; withoutFasitAttempts=0;
}
function reset(){
  fitCanvas();
  snake=[{x:Math.floor(cols/2), y:Math.floor(rows/2)}];
  dir={x:1,y:0}; nextDir={x:1,y:0};
  score=0; lives=3; growth=0;
  ui.score.textContent=score; ui.lives.textContent="‚ù§‚ù§‚ù§";
  resetStats();
  placeAllApples();
  paused=false; ui.start.textContent="Restart";
  ui.startOverlay.style.display="none";
  cancelAnimationFrame(loopId); draw(); loopId=requestAnimationFrame(tick);
}

/* ====== Tegn ====== */
function draw(){
  ctx.fillStyle="#0a1020"; ctx.fillRect(0,0,cv.width,cv.height);
  ctx.strokeStyle="rgba(34,48,89,.6)"; ctx.lineWidth=1;
  for(let i=0;i<=cols;i++){ ctx.beginPath(); ctx.moveTo(i*grid,0); ctx.lineTo(i*grid,cv.height); ctx.stroke(); }
  for(let j=0;j<=rows;j++){ ctx.beginPath(); ctx.moveTo(0,j*grid); ctx.lineTo(cv.width,j*grid); ctx.stroke(); }

  ctx.font="bold 18px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
  apples.forEach(a=>{ if(!a.done) ctx.fillText("üçé", a.x*grid+grid/2, a.y*grid+grid/2); });

  ctx.fillStyle="#79c8ff";
  snake.forEach((s,i)=>{
    const x=s.x*grid, y=s.y*grid;
    ctx.fillRect(x+2,y+2,grid-4,grid-4);
    if(i===0){ ctx.fillStyle="#0b1020"; ctx.fillRect(x+6,y+8,3,3); ctx.fillRect(x+grid-9,y+8,3,3); ctx.fillStyle="#79c8ff"; }
  });
}

/* ====== ‚ÄúLett √• treffe‚Äù (magnet) ====== */
function isAppleCaught(head){
  const a = apples.find(ap => !ap.done && ap.x===head.x && ap.y===head.y);
  if(a) return a;
  if(!ui.assist.checked) return null;
  // naboceller (Chebyshev dist <= 1)
  return apples.find(ap => !ap.done && Math.max(Math.abs(ap.x-head.x), Math.abs(ap.y-head.y))===1) || null;
}

/* ====== Loop ====== */
function tick(ts){
  fitCanvas();
  if(paused){ draw(); loopId=requestAnimationFrame(tick); return; }
  if(ts-lastTick<speedMs){ loopId=requestAnimationFrame(tick); return; }
  lastTick=ts;

  if(nextDir.x!==-dir.x || nextDir.y!==-dir.y) dir=nextDir;

  const head={...snake[0]};
  head.x+=dir.x; head.y+=dir.y;

  if(head.x<0) head.x=cols-1; else if(head.x>=cols) head.x=0;
  if(head.y<0) head.y=rows-1; else if(head.y>=rows) head.y=0;

  if(snake.some(p=>p.x===head.x && p.y===head.y)){
    loseLife("Traff halen"); draw(); loopId=requestAnimationFrame(tick); return;
  }

  snake.unshift(head);

  const hit = isAppleCaught(head);
  if(hit){ paused=true; askQuestionFor(hit.index); }
  else { if(growth>0) growth--; else snake.pop(); }

  draw(); loopId=requestAnimationFrame(tick);
}

/* ====== Sp√∏rsm√•l / fasit / scoring ====== */
let usedFasitThisRound=false, currentIndex=null;

btnToggleQFasit.addEventListener('click', (e)=>{
  const show = qFasitDiv.style.display !== 'block';
  qFasitDiv.style.display = show ? 'block' : 'none';
  e.target.textContent = show ? 'Skjul fasit ‚ñ≤' : 'Vis fasit ‚ñº';
  if(show) usedFasitThisRound = true; // halv poeng denne runden
});

function askQuestionFor(index){
  currentIndex = index;
  usedFasitThisRound = false;
  norw.textContent = PAIRS[index].no;
  ans.value = "";
  qFasitDiv.style.display="none"; btnToggleQFasit.textContent="Vis fasit ‚ñº";
  showQuestion(); setTimeout(()=>ans.focus({preventScroll:true}), 50);
}

function handleAnswer(ok){
  hideModal();
  const a = apples.find(x=>x.index===currentIndex); if(a) a.done = true;
  ui.remain.textContent = apples.filter(x=>!x.done).length;

  if(usedFasitThisRound) withFasitAttempts++; else withoutFasitAttempts++;
  if(ok){
    correctCount++;
    const add = usedFasitThisRound ? 5 : 10;
    score += add; ui.score.textContent=score;
    growth += 2; speedMs=Math.max(1000/16, speedMs*0.985);
    toast(usedFasitThisRound ? `‚úÖ Riktig! +${add} (fasit brukt)` : `‚úÖ Riktig! +${add}`, true, 1300);
  }else{
    wrongCount++; loseLife("‚ùå Feil svar");
  }

  if(apples.every(x=>x.done)){ showSummary(); return; }
  paused=false;
}
function checkAnswer(){ if(currentIndex==null) return; handleAnswer( norm(ans.value)===norm(PAIRS[currentIndex].en) ); }
btnCheck.onclick=checkAnswer;
ans.addEventListener('keydown', e=>{ if(e.key==="Enter") checkAnswer(); });
btnSkip.onclick=()=>{ handleAnswer(false); };

/* ====== Modal helpers ====== */
function showQuestion(){ questionView.style.display="block"; summaryView.style.display="none"; modal.style.display="flex"; }
function showSummary(){
  summaryText.innerHTML = `
    Riktige svar: <b>${correctCount}</b><br>
    Feil svar: <b>${wrongCount}</b><br>
    Besvart med fasit: <b>${withFasitAttempts}</b><br>
    Besvart uten fasit: <b>${withoutFasitAttempts}</b>
  `;
  questionView.style.display="none"; summaryView.style.display="block"; modal.style.display="flex";
}
function hideModal(){ modal.style.display="none"; }

/* ====== Liv / slutt ====== */
function loseLife(reason){
  lives--; ui.lives.textContent="‚ù§".repeat(Math.max(lives,0));
  toast(`${reason} ‚Äì1 liv`, false, 1100);
  if(lives<=0){ return gameOver(); }
  snake=[{x:Math.floor(cols/2), y:Math.floor(rows/2)}]; dir={x:1,y:0}; nextDir={x:1,y:0}; growth=0;
}
function gameOver(){
  paused=true;
  const best=Number(localStorage.getItem(LS_KEY)||0);
  if(score>best){ localStorage.setItem(LS_KEY,String(score)); ui.best.textContent=score; }
  toast(`üïπÔ∏è Game over ‚Äì Poeng: ${score}`, false, 1600);
  ui.startOverlay.style.display="flex";
  ui.start.textContent="Start / Restart";
}

/* ====== Kontroller ====== */
function setDir(dx,dy){ if(dx===-dir.x && dy===-dir.y) return; nextDir={x:dx,y:dy}; }
window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(["arrowup","w"].includes(k)) setDir(0,-1);
  else if(["arrowdown","s"].includes(k)) setDir(0,1);
  else if(["arrowleft","a"].includes(k)) setDir(-1,0);
  else if(["arrowright","d"].includes(k)) setDir(1,0);
});
if(ui.up){ ui.up.onclick=()=>setDir(0,-1); ui.down.onclick=()=>setDir(0,1); ui.left.onclick=()=>setDir(-1,0); ui.right.onclick=()=>setDir(1,0); }

/* ====== UI ====== */
// sl√• p√• ‚ÄúLett √• treffe‚Äù automatisk p√• sm√• mobiler
ui.assist.checked = window.innerWidth <= 600;

function startGame(){
  speedMs = 1000/Number(ui.speed.value);
  if(ui.speedShow) ui.speedShow.textContent=ui.speed.value;
  reset();
}
ui.start.onclick = startGame;
ui.bigStart.onclick = startGame;
ui.pause.onclick = ()=>{ paused=!paused; ui.pause.textContent=paused?"Fortsett":"Pause"; };
ui.speed.addEventListener('input', ()=>{ if(ui.speedShow) ui.speedShow.textContent=ui.speed.value; speedMs=1000/Number(ui.speed.value); });
restartAll.onclick = ()=>{ hideModal(); startGame(); };

/* ====== Boot ====== */
fitCanvas(); draw();
</script>
</body>
</html>
