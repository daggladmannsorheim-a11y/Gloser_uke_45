<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>Snake ‚Äì Gloser uke 45 (Kampen 6. trinn)</title>
<style>
  :root{
    --bg:#0c1020; --panel:#151a2b; --ink:#eef3fb; --muted:#9fb1d1;
    --line:#223059; --good:#42d392; --bad:#ff6b6b;
    --head:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100vh;margin:0;background:#0c1020;color:var(--ink);
            font:16px system-ui,Segoe UI,Roboto,Arial}
  @media (min-width:900px){ html,body{overflow:hidden} }

  header{
    height:auto; padding:8px 14px; background:rgba(21,26,43,.95);
    border-bottom:1px solid var(--line); position:sticky; top:0; text-align:center
  }
  h1{margin:0; font-size:18px}
  .muted{color:var(--muted)}

  .screen{
    height: calc(100vh - var(--head));
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:12px; padding:8px;
  }
  @media (max-width:900px){
    .screen{grid-template-columns:1fr; height:auto; min-height:calc(100vh - var(--head))}
  }

  #canvasBox{
    background: radial-gradient(1000px 480px at 30% -8%, #18234a, #0c1020 60%);
    border:1px solid var(--line); border-radius:12px; padding:8px;
    display:flex; align-items:center; justify-content:center; min-height:0;
  }
  #game{
    width:100%; height:100%; aspect-ratio: 3 / 2;
    background:#0a1020; border:1px solid #1b274b; border-radius:10px;
    touch-action:none; display:block;
  }

  #side{
    display:flex; flex-direction:column; gap:10px;
    background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px;
    min-height:0;
  }
  .chips{display:flex; flex-wrap:wrap; gap:6px}
  .chip{display:inline-flex; gap:6px; align-items:center; background:#1a2240;
        border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:14px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  button{
    appearance:none; background:#1b274b; color:var(--ink); border:1px solid var(--line);
    padding:8px 12px; border-radius:10px; font-weight:700; font-size:15px
  }
  button:active{transform:translateY(1px)}
  .btn-prim{background:#1b3b2e; border-color:#225a42}

  #mobControls{display:none}
  @media (max-width:900px){
    #mobControls{display:grid; place-items:center; gap:6px}
    #mobControls .row{display:flex; gap:14px; justify-content:center}
    #mobControls button{width:70px; height:70px; font-size:30px; border-radius:14px}
  }

  /* Sp√∏rsm√•l-modal */
  #modal{
    position:fixed; inset:0; background:rgba(0,0,0,.55); display:none;
    align-items:center; justify-content:center; z-index:50; padding:10px
  }
  #card{
    width:min(92vw,560px); background:#0f1734; border:1px solid #2a3a68;
    border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  #ans{
    width:100%; padding:12px 14px; font-size:18px; border-radius:10px;
    border:1px solid #2a3a68; background:#101833; color:#fff
  }
  .good{color:var(--good)} .bad{color:var(--bad)}
  #qFasit{display:none; margin-top:10px; max-height:40vh; overflow:auto;
          border:1px solid #2a3a68; border-radius:10px}
  table{width:100%; border-collapse:collapse; font-size:15px}
  th,td{border:1px solid #2a3a68; padding:6px 8px; text-align:left}
  th{background:#1a2240}

  /* Oppsummering-modal */
  #summary{
    position:fixed; inset:0; background:rgba(0,0,0,.65); display:none;
    align-items:center; justify-content:center; z-index:60; padding:10px
  }
  #sumcard{
    width:min(92vw,560px); background:#111a36; border:1px solid #2a3a68;
    border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.4)
  }
  #sumlist{margin:8px 0 0; line-height:1.6}
</style>
</head>
<body>
<header>
  <h1>Snake ‚Äì Gloser ‚Ä¢ Uke 45</h1>
  <div class="muted">Hei 6. trinn p√• Kampen skole! Kos dere med glosespill ‚Äì l√¶r, spill og ha det g√∏y üçéüêç</div>
</header>

<section class="screen">
  <div id="canvasBox">
    <canvas id="game" width="900" height="600" aria-label="Snake-spill"></canvas>
  </div>

  <aside id="side">
    <div class="chips">
      <span class="chip">Poeng: <b id="score">0</b></span>
      <span class="chip">Liv: <b id="lives">‚ù§‚ù§‚ù§</b></span>
      <span class="chip">Fart: <b id="speedShow">7</b></span>
      <span class="chip">Topp: <b id="best">0</b></span>
      <span class="chip">Gjenst√•r: <b id="remain">10</b></span>
    </div>

    <div class="row">
      <button id="start" class="btn-prim">Start / Restart</button>
      <button id="pause">Pause</button>
      <label>Fart <input id="speed" type="range" min="4" max="16" value="7" /></label>
    </div>

    <div id="mobControls">
      <div class="row"><button id="up">‚¨ÜÔ∏è</button></div>
      <div class="row">
        <button id="left">‚¨ÖÔ∏è</button>
        <button id="down">‚¨áÔ∏è</button>
        <button id="right">‚û°Ô∏è</button>
      </div>
    </div>
  </aside>
</section>

<!-- Sp√∏rsm√•l -->
<div id="modal">
  <div id="card">
    <p style="margin:0 0 8px">Skriv engelsk for: <span id="norw" class="good"></span></p>
    <input id="ans" type="text" inputmode="latin" autocomplete="off" autocapitalize="none" spellcheck="false"
           placeholder="skriv engelsk og trykk Enter/Sjekk" />
    <div class="row" style="justify-content:space-between; margin-top:10px">
      <div class="row">
        <button id="check" class="btn-prim">Sjekk</button>
        <button id="skip">Hopp over (‚Äì1 liv)</button>
      </div>
      <button id="toggleQFasit">Vis fasit ‚ñº</button>
    </div>
    <div id="qFasit"></div>
  </div>
</div>

<!-- Oppsummering -->
<div id="summary">
  <div id="sumcard">
    <h3 style="margin:0 0 6px">Oppsummering ‚Äì Uke 45</h3>
    <div id="sumlist"></div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="sumClose" class="btn-prim">Spill igjen</button>
    </div>
  </div>
</div>

<script>
/* ====== Gloser uke 45 ====== */
const PAIRS = [
  {en:"Decent", no:"ordentlig"},
  {en:"Grin", no:"smil"},
  {en:"Terrified", no:"veldig redd"},
  {en:"Wailed", no:"gr√•t"},
  {en:"Yelping", no:"bjeffende"},
  {en:"Leer", no:"sultent blikk"},
  {en:"Furry coat", no:"pelsk√•pe"},
  {en:"Flickers", no:"blunker i rykninger"},
  {en:"Whips out", no:"trekker frem"},
  {en:"Knickers", no:"underbukser"}
];

/* ====== Header-h√∏yde (for 100vh-layout) ====== */
function setHeaderVar(){
  const h = document.querySelector('header').offsetHeight || 56;
  document.documentElement.style.setProperty('--head', h + 'px');
}
window.addEventListener('resize', setHeaderVar);
setHeaderVar();

/* ====== DOM ====== */
const cv = document.getElementById('game');
const ctx = cv.getContext('2d');
const ui = {
  score: document.getElementById('score'),
  lives: document.getElementById('lives'),
  best: document.getElementById('best'),
  speed: document.getElementById('speed'),
  speedShow: document.getElementById('speedShow'),
  start: document.getElementById('start'),
  pause: document.getElementById('pause'),
  up: document.getElementById('up'),
  down: document.getElementById('down'),
  left: document.getElementById('left'),
  right: document.getElementById('right'),
  remain: document.getElementById('remain')
};
const modal = document.getElementById('modal');
const norw  = document.getElementById('norw');
const ans   = document.getElementById('ans');
const btnCheck = document.getElementById('check');
const btnSkip  = document.getElementById('skip');
const btnToggleQFasit = document.getElementById('toggleQFasit');
const qFasitDiv = document.getElementById('qFasit');

const summary = document.getElementById('summary');
const sumlist = document.getElementById('sumlist');
const sumClose = document.getElementById('sumClose');

const LS_KEY = "snake45_best_summary_all";
ui.best.textContent = localStorage.getItem(LS_KEY) || 0;

/* ====== Bygg fasit-tabell i modal (engelsk ‚Üí norsk) ====== */
qFasitDiv.innerHTML = `<table>
  <tr><th>Engelsk</th><th>Norsk</th></tr>
  ${PAIRS.map(p=>`<tr><td>${p.en}</td><td>${p.no}</td></tr>`).join('')}
</table>`;

/* ====== Canvas sizing (3:2) ====== */
let grid = 24, cols = Math.floor(cv.width / grid), rows = Math.floor(cv.height / grid);
function fitCanvas(){
  const box = document.getElementById('canvasBox');
  const bw = box.clientWidth - 16, bh = box.clientHeight - 16;
  if (bw <= 0 || bh <= 0) return;
  let targetW = bw, targetH = Math.round(bw * 2/3);
  if (targetH > bh){ targetH = bh; targetW = Math.round(bh * 3/2); }
  cv.style.width = targetW + 'px';
  cv.style.height = targetH + 'px';
  const ratio = window.devicePixelRatio || 1;
  const w = Math.floor(targetW * ratio);
  const h = Math.floor(targetH * ratio);
  if (cv.width !== w || cv.height !== h){
    cv.width = w; cv.height = h;
    cols = Math.floor(w / grid);
    rows = Math.floor(h / grid);
  }
}
window.addEventListener('resize', fitCanvas);

/* ====== Utils ====== */
const rand = n => Math.floor(Math.random()*n);
const norm = s => s.trim().toLowerCase().replace(/\s+/g," ");
function toast(msg, ok=true, t=1200){
  const e=document.createElement('div');
  e.textContent=msg;
  e.style.position="fixed"; e.style.left="50%"; e.style.top="50%";
  e.style.transform="translate(-50%,-50%)";
  e.style.background= ok ? "#1f503a" : "#5b2230";
  e.style.color="#fff"; e.style.padding="14px 18px";
  e.style.borderRadius="12px"; e.style.fontSize="22px"; e.style.fontWeight="800";
  e.style.boxShadow="0 0 20px rgba(0,0,0,.5)"; e.style.zIndex=200;
  document.body.appendChild(e);
  setTimeout(()=>e.remove(), t);
}

/* ====== Spilltilstand ====== */
let snake, dir, nextDir, score, lives, paused=true, loopId=null, lastTick=0,
    speedMs = 1000/7, growth=0;

/* Epler: ett per glose */
let apples = []; // {x,y, idx} der idx peker inn i PAIRS
/* P√•g√•ende sp√∏rsm√•l */
let currentIdx = null;
let usedFasitThisRound = false;

/* Statistikk */
let correct = 0, wrong = 0, correctWithFasit = 0, correctWithoutFasit = 0;

/* ====== Start/Reset ====== */
function freeCellAvoidSnakeAndApples(){
  let x,y,tries=0;
  do{
    x=rand(cols); y=rand(rows); tries++;
    if(tries>2000) break;
  }while(
    snake.some(s=>s.x===x&&s.y===y) ||
    apples.some(a=>a.x===x && a.y===y)
  );
  return {x,y};
}
function seedAllApples(){
  apples = [];
  for(let idx=0; idx<PAIRS.length; idx++){
    const pos = freeCellAvoidSnakeAndApples();
    apples.push({x:pos.x, y:pos.y, idx});
  }
  ui.remain.textContent = String(apples.length);
}
function reset(){
  fitCanvas();
  snake = [{x:Math.floor(cols/2), y:Math.floor(rows/2)}];
  dir = {x:1,y:0}; nextDir = {x:1,y:0};
  score = 0; lives = 3; growth = 0;
  correct = 0; wrong = 0; correctWithFasit = 0; correctWithoutFasit = 0;
  ui.score.textContent = score; ui.lives.textContent = "‚ù§‚ù§‚ù§";
  seedAllApples();
  paused = false; cancelAnimationFrame(loopId); draw(); loopId = requestAnimationFrame(tick);
}

/* ====== Tegn ====== */
function draw(){
  ctx.fillStyle="#0a1020"; ctx.fillRect(0,0,cv.width,cv.height);
  ctx.strokeStyle="rgba(34,48,89,.6)"; ctx.lineWidth=1;
  for(let i=0;i<=cols;i++){ ctx.beginPath(); ctx.moveTo(i*grid,0); ctx.lineTo(i*grid,cv.height); ctx.stroke(); }
  for(let j=0;j<=rows;j++){ ctx.beginPath(); ctx.moveTo(0,j*grid); ctx.lineTo(cv.width,j*grid); ctx.stroke(); }

  // alle epler
  ctx.font="bold 18px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
  apples.forEach(a=>{
    ctx.fillText("üçé", a.x*grid+grid/2, a.y*grid+grid/2);
  });

  // slange
  ctx.fillStyle="#79c8ff";
  snake.forEach((s,i)=>{
    const x=s.x*grid, y=s.y*grid;
    ctx.fillRect(x+2,y+2,grid-4,grid-4);
    if(i===0){ ctx.fillStyle="#0b1020"; ctx.fillRect(x+6,y+8,3,3); ctx.fillRect(x+grid-9,y+8,3,3); ctx.fillStyle="#79c8ff"; }
  });
}

/* ====== Loop ====== */
function tick(ts){
  fitCanvas();
  if(paused){ draw(); loopId = requestAnimationFrame(tick); return; }
  if(ts - lastTick < speedMs){ loopId = requestAnimationFrame(tick); return; }
  lastTick = ts;

  if(nextDir.x!==-dir.x || nextDir.y!==-dir.y) dir = nextDir;

  const head = {...snake[0]};
  head.x += dir.x; head.y += dir.y;
  // gjennom vegger
  if(head.x<0) head.x=cols-1; else if(head.x>=cols) head.x=0;
  if(head.y<0) head.y=rows-1; else if(head.y>=rows) head.y=0;

  // selvkollisjon
  if(snake.some(p=>p.x===head.x && p.y===head.y)){
    loseLife("Traff halen"); draw(); loopId=requestAnimationFrame(tick); return;
  }

  snake.unshift(head);

  // eple-treff? (sjekk mot alle)
  const hitIndex = apples.findIndex(a=>a.x===head.x && a.y===head.y);
  if(hitIndex>-1){
    // stopp og sp√∏r for akkurat den glosen
    paused=true;
    currentIdx = apples[hitIndex].idx;
    usedFasitThisRound = false;
    openQuestion(currentIdx, hitIndex); // send ogs√• indeksen i apples-lista
  }else{
    if(growth>0) growth--; else snake.pop();
  }

  draw(); loopId=requestAnimationFrame(tick);
}

/* ====== Sp√∏rsm√•l ====== */
function openQuestion(idx, applesIndex){
  norw.textContent = PAIRS[idx].no;
  ans.value="";
  qFasitDiv.style.display="none";
  btnToggleQFasit.textContent="Vis fasit ‚ñº";
  modal.dataset.appleIndex = String(applesIndex); // lagre hvilken apple som ble truffet
  modal.style.display="flex";
  setTimeout(()=>ans.focus({preventScroll:true}), 50);
}
btnToggleQFasit.addEventListener('click', (e)=>{
  const show = qFasitDiv.style.display !== 'block';
  qFasitDiv.style.display = show ? 'block' : 'none';
  e.target.textContent = show ? 'Skjul fasit ‚ñ≤' : 'Vis fasit ‚ñº';
  if(show) usedFasitThisRound = true;
});

function handleAnswer(ok){
  modal.style.display="none";
  const ai = Number(modal.dataset.appleIndex);
  // Fjern eplet uansett (oppgaven regnes som besvart)
  if(ai>=0 && ai<apples.length){
    apples.splice(ai,1);
    ui.remain.textContent = String(apples.length);
  }
  if(ok){
    const add = usedFasitThisRound ? 5 : 10;
    score += add; ui.score.textContent = score;
    growth += 2; speedMs = Math.max(1000/16, speedMs*0.985);
    correct++;
    if(usedFasitThisRound) correctWithFasit++; else correctWithoutFasit++;
    toast(usedFasitThisRound ? `‚úÖ Riktig! +${add} (fasit brukt)` : `‚úÖ Riktig! +${add}`, true, 1300);
  }else{
    wrong++; loseLife("‚ùå Feil svar");
  }
  // Ferdig med alle?
  if(apples.length===0){
    paused = true;
    showSummary();
    return;
  }
  paused=false;
}
function checkAnswer(){
  if(currentIdx==null) return;
  handleAnswer( norm(ans.value) === norm(PAIRS[currentIdx].en) );
}
btnCheck.onclick = checkAnswer;
ans.addEventListener('keydown', e=>{ if(e.key==="Enter") checkAnswer(); });
btnSkip.onclick = ()=>{
  modal.style.display="none";
  wrong++; loseLife("Hoppet over");
  // Ogs√• telle oppgaven som ‚Äúbesvart‚Äù og fjerne eplet
  const ai = Number(modal.dataset.appleIndex);
  if(ai>=0 && ai<apples.length){
    apples.splice(ai,1);
    ui.remain.textContent = String(apples.length);
  }
  if(apples.length===0){
    paused = true; showSummary(); return;
  }
  paused=false;
};

/* ====== Oppsummering ====== */
function showSummary(){
  // Oppdater best-score ogs√• her
  const best = Number(localStorage.getItem(LS_KEY)||0);
  if(score>best){ localStorage.setItem(LS_KEY,String(score)); ui.best.textContent = score; }
  sumlist.innerHTML = `
    <div>Poeng: <b>${score}</b></div>
    <div>Riktige: <b>${correct}</b></div>
    <div>Feil: <b>${wrong}</b></div>
    <div>Riktige uten fasit: <b>${correctWithoutFasit}</b></div>
    <div>Riktige med fasit: <b>${correctWithFasit}</b></div>
  `;
  summary.style.display="flex";
}
sumClose.onclick = ()=>{ summary.style.display="none"; reset(); };

/* ====== Liv / slutt ====== */
function loseLife(reason){
  lives--; ui.lives.textContent = "‚ù§".repeat(Math.max(lives,0));
  toast(`${reason} ‚Äì1 liv`, false, 1100);
  if(lives<=0){
    // Hvis man d√∏r f√∏r alle epler er tatt, vis ‚Äúgame over‚Äù og tilbud restart
    paused=true;
    const best = Number(localStorage.getItem(LS_KEY)||0);
    if(score>best){ localStorage.setItem(LS_KEY,String(score)); ui.best.textContent = score; }
    sumlist.innerHTML = `
      <div>üïπÔ∏è Game over</div>
      <div>Poeng: <b>${score}</b></div>
      <div>Riktige: <b>${correct}</b></div>
      <div>Feil: <b>${wrong}</b></div>
      <div>Riktige uten fasit: <b>${correctWithoutFasit}</b></div>
      <div>Riktige med fasit: <b>${correctWithFasit}</b></div>
      <div>Gjenst√•ende oppgaver: <b>${apples.length}</b></div>
    `;
    summary.style.display="flex";
    return;
  }
  // myk reset av slange
  snake=[{x:Math.floor(cols/2), y:Math.floor(rows/2)}];
  dir={x:1,y:0}; nextDir={x:1,y:0}; growth=0;
}

/* ====== Kontroller ====== */
function setDir(dx,dy){ if(dx===-dir.x && dy===-dir.y) return; nextDir={x:dx,y:dy}; }
window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(["arrowup","w"].includes(k)) setDir(0,-1);
  else if(["arrowdown","s"].includes(k)) setDir(0,1);
  else if(["arrowleft","a"].includes(k)) setDir(-1,0);
  else if(["arrowright","d"].includes(k)) setDir(1,0);
});
if(ui.up){ ui.up.onclick=()=>setDir(0,-1); ui.down.onclick=()=>setDir(0,1); ui.left.onclick=()=>setDir(-1,0); ui.right.onclick=()=>setDir(1,0); }

/* ====== UI ====== */
ui.start.onclick = ()=>{
  speedMs = 1000/Number(ui.speed.value);
  ui.speedShow.textContent = ui.speed.value;
  reset();
};
ui.pause.onclick = ()=>{
  paused = !paused;
  ui.pause.textContent = paused ? "Fortsett" : "Pause";
};
ui.speed.addEventListener('input', ()=>{
  ui.speedShow.textContent = ui.speed.value;
  speedMs = 1000/Number(ui.speed.value);
});

/* ====== Boot ====== */
fitCanvas(); draw();
</script>
</body>
</html>
